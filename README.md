Aloi Davide - PhD Student (University of Birmingham - Centre for Human Brain Health)

# Analysis of relationship between tDCS-induced current density and effective connectivity changes in the motor network

The goal of these analyses is to assess the relationship between current density, as simulated using [ROAST](https://github.com/andypotatohy/roast#5-outputs-of-roast-software) pipeline (Huang et al., 2019), and effective connectivity changes within the motor network, derived using DCM and parametric empirical bayes (PEB). 

Three datasets are analysed: 
- wp1a and wp1b: participants received one session of anodal, cathodal and sham stimulations, in a counterbalanced order. In wp1a, the target of the stimulation was the left motor cortex. In wp1b, the target was the right cerebellum. Connectivity in the motor network was estimated using dynamic causal modelling (DCM) both before and after stimulation, while participants performed a motor task (simple thumb movement). PEB was then used to estimate the differences between pre and post stimulation. In these analyses, we use single-subject changes in connectivity and correlate them with current density metrics. The datasets are the same of [Aloi et al. (2021)](https://www.sciencedirect.com/science/article/pii/S1053811921010533?via%3Dihub).
- wp2a: same design as above but the stimulation was administered coupled with passive mobilisation of the thumb. The target of the stimulation was the left motor cortex. Participants received 5 stimulations per week, with one week gap between each stimulation condition, and were scanned on Day-1 and Day-5 of each week. I am analysing only DCM data from Day-1.

The two analyses are:
1) Correlation analysis between current density (that is, medians and max values of M1, Thalamus and Cerebellum) and DCM values (changes in effective connectivity after stimulation) (as in Indahlastari et al., 2021).

2) Pattern-recognition analysis using support vector machine (SVM) learning algorithm on MRI-derived tDCS current models to provide classification of tDCS treatment response, as reflected by increased M1-TH or TH-M1 connectivity (or whatever other measure we decide to use). e.g. Albizu et al. (2020). The question is: can we classify people who had an increase in thalamo-cortical connectivity using features from the MRI-current models?

## Steps with respective scripts
NB. UPDATING WITH NEW SCRIPTS

1) [Rename files](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_1_rename_scans.py): this renames the anatomical scans of each participant (i.e. sub-01_T1.nii etc) of dataset wp2a. 
2) Roast simulations: in brief, ROAST outputs the following scans for each subject, while also using SPM routines for tissue segmentation: Voltage ("subjName_simulationTag_v.nii", unit in mV), E-field ("subjName_simulationTag_e.nii", unit in V/m) and E-field magnitude ("subjName_simulationTag_emag.nii", unit in V/m). This was done for all three datasets, using the following parameters:
   - [wp1a](https://github.com/Davi93/wp1_2_roast/blob/main/wp1a_roast_2_roast_simulation.m) and [wp2a](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_2_roast_simulation.m): anode on C3,              cathode on Fp2. Intensity: 1mA. For wp2a segmentations were done using both T1 and T2 scans. For        wp1a I used only T1s due to T2s presenting many artefacts which were leading to bad / failed            segmentations (same   for wp1b). 
   - [wp1b](https://github.com/Davi93/wp1_2_roast/blob/main/wp1b_roast_2_roast_simulation.m): for this      dataset I used the EGI system. The anode was placed over E239 (right buccinator) and the cathode        over E157 (right cerebellum). Intensity: 1.85mA. 

3) Post ROAST preprocessing: ROAST outputs are in ROAST model space. These scripts move ROAST results back to the MRI space, coregisters and normalises the electric field maps generated by ROAST. The script also normalise the T1 scan and all the masks. NB. ROAST creates a mask in which it combines all spm maks, after applying morphological operations and heuristics on SPM masks to remove holes (unassigned voxels). This mask will be used to calculate current density starting from electric field magnitude. Scripts: [wp2a](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_3_post_roast_preprocessing.m), [wp1a](https://github.com/Davi93/wp1_2_roast/blob/main/wp1a_roast_3_post_roast_preprocessing.m), [wp1b](https://github.com/Davi93/wp1_2_roast/blob/main/wp1b_roast_3_post_roast_preprocessing.m). All these three scripts refer to the same [job](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_3_post_roast_preprocessing_job.m) file.
4) DCM values extraction: DCM values (pre < post) are extracted and saved in .mat files containing N subject x 3 (stimulation conditions) structures. [Wp2a](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_4_extract_single_dcms.m), wp1a (I am waiting for Davinia to send me her results), wp1b ([1](https://github.com/Davi93/wp1_2_roast/blob/main/wp1b_roast_4_1_run_and_extract_single_dcms.m), [2](https://github.com/Davi93/wp1_2_roast/blob/main/wp1b_roast_4_2_extract_single_dcms.m)).
5) Estimation of single-subject posterior probability: this is done at the single subject level, to see which connections showed a significant increase. [Wp2a](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_5_single_subject_BMA.m), wp1a, [wp1b](https://github.com/Davi93/wp1_2_roast/blob/main/wp1b_roast_5_single_subject_BMA.m). 
8) [Estimation of posterior probability](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_5_single_subject_BMA.m) associated to each PEB extracted above. The script runs bayesian model averages for each PEB using the DCM function spm_dcm_peb_bmc. Results are saved in [this](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_DCMfiles/PEB_preVsPostDay1.mat) .mat structure.
9) [WP2a e-magnitude measures estimation and correlation analysis](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_6_data_analysis.ipynb).
Steps: (!!! This has to be updated)
   1) Load MNI template and M1/Th ROIs;
   2) Load .mat structure with Ep values;
   3) For each subject:
      1) Load normalised scan containing E-field magnitude (wsub-*_T1_*_emag.nii);
      2) Load brain mask generated by SPM and touched up by ROAST (wsub-*T1*T2_masks.nii);
      3) Save DCM values related to the connections M1-M1, Th-Th, M1->Th and Th-> M1;
      4) Calculate current density map starting from electric field map and brain mask; 
      5) Mask E-field and current density maps using MNI template, to exclude values outside the brain; 
      6) Mask current density map using M1 and Th ROIs and estimate means, medians and max values within these two ROIs;
      7) Save current density derived measures;
      9) Run 16 correlations: 4 DCM measures and 4 current density measures (medians and max values);

## Functions
Functions are contained in folder [custom_functions](https://github.com/Davi93/wp1_2_roast/tree/main/custom_functions)

-- [Maps functions](https://github.com/Davi93/wp1_2_roast/blob/main/custom_functions/maps_functions.py): these are functions that perform operations on MRI scans.
- current_density_efield: calculates current density map starting from electric field magnitude map and brain mask. 

-- [Plotting functions](https://github.com/Davi93/wp1_2_roast/blob/main/custom_functions/plotting_functions.py)
- roast_vector_sim: plots electric field directions and intensities. 

## Plots
![e-field_figure](https://user-images.githubusercontent.com/4202630/149754221-386e4582-4a39-4723-8e4f-cd94f999f839.png)
![current_density_figure](https://user-images.githubusercontent.com/4202630/149754258-0eecab03-5c3a-431a-a19c-42adada65021.png)


## To Do list

1) finish machine learning part script;
2) reorganise the code;
3) analyse wp1a and wp1b datasets;
4) add summary to readme page;

## References:
1) Huang, Y., Datta, A., Bikson, M., & Parra, L. C. (2019). Realistic volumetric-approach to simulate transcranial electric stimulation—ROAST—a fully automated open-source pipeline. Journal of Neural Engineering, 16(5), 056006. https://doi.org/10.1088/1741-2552/ab208d
2) Indahlastari, A., Albizu, A., Kraft, J. N., O’Shea, A., Nissim, N. R., Dunn, A. L., Carballo, D., Gordon, M. P., Taank, S., Kahn, A. T., Hernandez, C., Zucker, W. M., & Woods, A. J. (2021). Individualized tDCS modeling predicts functional connectivity changes within the working memory network in older adults. Brain Stimulation, 14(5), 1205–1215. https://doi.org/10.1016/j.brs.2021.08.003
3) Albizu, A., Fang, R., Indahlastari, A., O’Shea, A., Stolte, S. E., See, K. B., Boutzoukas, E. M., Kraft, J. N., Nissim, N. R., & Woods, A. J. (2020). Machine learning and individual variability in electric field characteristics predict tDCS treatment response. Brain Stimulation, 13(6), 1753–1764. https://doi.org/10.1016/j.brs.2020.10.001

