Aloi Davide - PhD Student (University of Birmingham - Centre for Human Brain Health)

# Analysis of current density and correlation analysis with Dynamic Causal Modelling (DCM) results

The goal of these analyses is to establish whether there is a relationship between single-subject electric field (E-field) magnitudes generated with the [ROAST](https://github.com/andypotatohy/roast#5-outputs-of-roast-software) pipeline (Huang et al., 2019) and changes in effective connectivity within the motor network, derived using DCM and parametric empirical bayes (PEB). 

The two analyses are:
1) Correlation analysis between current density - medians and max values - in the motor cortex (M1) and Thalamus (Th), and self- / between-connectivities, as derived from the DCM. e.g. Indahlastari et al. (2021). At the moment I am correlating current density measures with DCM measures derived from the contrast pre vs post Day-1 anodal and pre vs post Day-1 sham.

2) Pattern-recognition analysis using support vector machine (SVM) learning algorithm on MRI-derived tDCS current models to provide classification of tDCS treatment response, as reflected by increased M1-TH or TH-M1 connectivity (or whatever other measure we decide). e.g. Albizu et al. (2020). The question is: can we classify people who had an increase in thalamo-cortical connectivity using features from the MRI-current models?  --> Working on this part!

## Steps with respective scripts
NB. I am working on the WP2A dataset only at the moment. The dataset has 22 folders (one per participant), each containing a T1 and a T2 scan. 
The simulation settings for wp2a (anodal over M1, cathodal over right OFC) are: (t1, {'C3',1.0,'Fp2',-1.0},'T2', t2,'electype', 'pad', 'elecsize', [50 50 3], 'capType', '1020').


1) [Rename files](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_1_rename_scans.py): this renames the anatomical scans of each participant (i.e. sub-01_T1.nii etc). 
2) [ROAST simulations](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_2_roast_simulation.m): this script runs the ROAST simulations. In brief, ROAST outputs the following scans for each subject, while also using SPM routines for tissue segmentation: Voltage ("subjName_simulationTag_v.nii", unit in mV), E-field ("subjName_simulationTag_e.nii", unit in V/m) and E-field magnitude ("subjName_simulationTag_emag.nii", unit in V/m).
3) [Post ROAST preprocessing](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_3_post_roast_preprocessing.m): ROAST outputs are in the ROAST model space. This script moves ROAST results back to the MRI space, coregisters and normalises the electric field maps generated by ROAST. The script also normalise the T1 scan and all the masks. NB. ROAST creates a scan in which it combines all the spm maks, after applying morphological operations and heuristics on SPM maps to remove holes in the masks (unassigned voxels). This mask will be used to calculate current densities starting from the electric field magnitude map.
4) [Ep values extraction from PEB result](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_4_extract_single_dcms.m) (Day-1 only): this script, starting from [this](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_DCMfiles/PEB_preVsPostDay1.mat) .mat structure containing 66 PEBs (1 per participant / polarity), extracts the Ep values for each participant. The resulting [file](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_DCMfiles/Day1_all_EPvalues.mat) contains 66 matrices (participant 1 anodal, cathodal and sham, participant 2 ... 22).
5) (no longer used) [Estimation of posterior probability](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_5_single_subject_BMA.m) associated to each PEB extracted above. The script runs bayesian model averages for each PEB using the DCM function spm_dcm_peb_bmc. Results are saved in [this](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_DCMfiles/PEB_preVsPostDay1.mat) .mat structure.
6) [WP2a e-magnitude measures estimation and correlation analysis](https://github.com/Davi93/wp1_2_roast/blob/main/wp2a_roast_6_data_analysis.ipynb).
Steps: (!!! This has to be updated)
   1) Load MNI template and M1/Th ROIs;
   2) Load .mat structure with Ep values; 
   3) For each subject: 
      1) Load normalised scan containing E-field magnitude (wsub-*_T1_*_emag.nii);
      2) Load brain mask generated by SPM and touched up by ROAST (wsub-*T1*T2_masks.nii);
      3) Save DCM values related to the connections M1-M1, Th-Th, M1->Th and Th-> M1;
      4) Calculate current density map starting from electric field map and brain mask; 
      5) Mask E-field and current density maps using MNI template, to exclude values outside the brain; 
      6) Mask current density map using M1 and Th ROIs and estimate means, medians and max values within these two ROIs; 
      7) Save current density derived measures;
      9) Run 16 correlations: 4 DCM measures and 4 current density measures (medians and max values);

## Functions
Functions are contained in folder [custom_functions](https://github.com/Davi93/wp1_2_roast/tree/main/custom_functions)

-- [Maps functions](https://github.com/Davi93/wp1_2_roast/blob/main/custom_functions/maps_functions.py)
These are functions that perform operations on MRI scans.
- current_density_efield: calculates current density map starting from electric field magnitude map and brain mask. 

-- [Plotting functions](https://github.com/Davi93/wp1_2_roast/blob/main/custom_functions/plotting_functions.py)
- roast_vector_sim: plots electric field directions and intensities. 

## Plots
![e-field_figure](https://user-images.githubusercontent.com/4202630/149754221-386e4582-4a39-4723-8e4f-cd94f999f839.png)
![current_density_figure](https://user-images.githubusercontent.com/4202630/149754258-0eecab03-5c3a-431a-a19c-42adada65021.png)


## To Do list

1) finish machine learning part script;
2) reorganise the code;
3) analyse wp1a and wp1b datasets;
4) add summary to readme page;

## References:
1) Huang, Y., Datta, A., Bikson, M., & Parra, L. C. (2019). Realistic volumetric-approach to simulate transcranial electric stimulation—ROAST—a fully automated open-source pipeline. Journal of Neural Engineering, 16(5), 056006. https://doi.org/10.1088/1741-2552/ab208d
2) Indahlastari, A., Albizu, A., Kraft, J. N., O’Shea, A., Nissim, N. R., Dunn, A. L., Carballo, D., Gordon, M. P., Taank, S., Kahn, A. T., Hernandez, C., Zucker, W. M., & Woods, A. J. (2021). Individualized tDCS modeling predicts functional connectivity changes within the working memory network in older adults. Brain Stimulation, 14(5), 1205–1215. https://doi.org/10.1016/j.brs.2021.08.003
3) Albizu, A., Fang, R., Indahlastari, A., O’Shea, A., Stolte, S. E., See, K. B., Boutzoukas, E. M., Kraft, J. N., Nissim, N. R., & Woods, A. J. (2020). Machine learning and individual variability in electric field characteristics predict tDCS treatment response. Brain Stimulation, 13(6), 1753–1764. https://doi.org/10.1016/j.brs.2020.10.001

